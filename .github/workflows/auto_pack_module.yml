name: Auto Pack Module

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'icons/**'
      - 'themes/**'
      - 'addition/module/**'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  pack-module:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup environment
      run: |
        echo "BUILD_TIME=$(TZ=':Asia/Shanghai' date '+%Y%m%d%H%M')" >> $GITHUB_ENV
        echo "BUILD_DATE=$(TZ=':Asia/Shanghai' date '+%Y.%m.%d')" >> $GITHUB_ENV
        echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
    - name: Pack icons and modules
      run: |
        # å¤åˆ¶é»˜è®¤ä¸»é¢˜åˆ° addition
        cp -rf ./themes/default ./addition
        
        # æ‰“åŒ…å›¾æ ‡
        echo "æ‰“åŒ…å›¾æ ‡..."
        mkdir -p ./addition/default/res/drawable-xxhdpi/
        cp -rf icons/* ./addition/default/res/drawable-xxhdpi/
        cd ./addition/default/
        zip -r -9 icons.zip * >/dev/null
        cd ../..
        
        # æ‰“åŒ… Magisk æ¨¡å—
        echo "æ‰“åŒ… Magisk æ¨¡å—..."
        cp -rf ./addition/default/icons.zip ./addition/module/icons
        cd ./addition/module
        
        # æ›´æ–° module.prop
        sed -i "s/versionCode=.*/versionCode=${{ env.BUILD_TIME }}/" module.prop
        echo "version=v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}" >> module.prop
        echo "description=MIUI å®Œç¾Žå›¾æ ‡è¡¥å…¨æ¨¡å— - è‡ªåŠ¨æž„å»ºäºŽ ${{ env.BUILD_DATE }}" >> module.prop
        
        # åŽ‹ç¼©å›¾æ ‡
        XZ_OPT=-9 tar cJf icons.tar.xz icons
        rm -rf icons
        
        # åˆ›å»ºæ¨¡å— zip
        zip -r -9 MIUI_Icons_Module.zip * >/dev/null
        mv MIUI_Icons_Module.zip ../../
        cd ../..
        
        # æ‰“åŒ…é»˜è®¤ MTZ ä¸»é¢˜
        echo "æ‰“åŒ…é»˜è®¤ MTZ ä¸»é¢˜..."
        cp -rf ./addition/default/icons.zip ./addition/mtz/default/icons
        cd ./addition/mtz/default
        zip -r -9 Default.mtz * >/dev/null
        mv Default.mtz ../../../
        cd ../../../
        
        # æ‰“åŒ…å›¾æ ‡æ’ä»¶
        echo "æ‰“åŒ…å›¾æ ‡æ’ä»¶..."
        cd ./addition/Icons_Addon
        zip -r -9 Icons_Addon.zip * >/dev/null
        mv Icons_Addon.zip ../../
        cd ../..
        
        # æ‰“åŒ…å½’æ¡£å›¾æ ‡
        echo "æ‰“åŒ…å½’æ¡£å›¾æ ‡..."
        cd ./addition/Icons_Archiving
        zip -r -9 Icons_Archiving.zip * >/dev/null
        mv Icons_Archiving.zip ../../
        cd ../..
        
        # æ‰“åŒ… Explore ä¸»é¢˜
        echo "æ‰“åŒ… Explore ä¸»é¢˜..."
        if [ -d "themes/explore" ]; then
          mkdir -p mtztemp/explore/res/drawable-xxhdpi/
          cp -rf icons/* mtztemp/explore/res/drawable-xxhdpi/
          if [ -d "themes/explore/icons" ]; then
            cp -rf themes/explore/icons/* mtztemp/explore/res/drawable-xxhdpi/
          fi
          if [ -d "themes/explore/layer_animating_icons" ]; then
            cp -rf themes/explore/layer_animating_icons mtztemp/explore/
          fi
          if [ -f "themes/explore/transform_config.xml" ]; then
            cp -rf themes/explore/transform_config.xml mtztemp/explore/
          fi
          cd mtztemp/explore/
          zip -r -9 icons.zip * >/dev/null
          cd ../..
          
          cp -rf ./mtztemp/explore/icons.zip ./addition/mtz/explore/icons
          cd addition/mtz/explore
          zip -r -9 Explore.mtz * >/dev/null
          mv Explore.mtz ../../../
          cd ../../../
        fi
        
        # æ‰“åŒ… Flyme9 ä¸»é¢˜
        echo "æ‰“åŒ… Flyme9 ä¸»é¢˜..."
        if [ -d "themes/flyme9" ]; then
          mkdir -p mtztemp/flyme9/res/drawable-xxhdpi/
          cp -rf icons/* mtztemp/flyme9/res/drawable-xxhdpi/
          if [ -d "themes/flyme9/icons" ]; then
            cp -rf themes/flyme9/icons/* mtztemp/flyme9/res/drawable-xxhdpi/
          fi
          if [ -d "themes/flyme9/layer_animating_icons" ]; then
            cp -rf themes/flyme9/layer_animating_icons mtztemp/flyme9/
          fi
          if [ -f "themes/flyme9/transform_config.xml" ]; then
            cp -rf themes/flyme9/transform_config.xml mtztemp/flyme9/
          fi
          cd mtztemp/flyme9/
          zip -r -9 icons.zip * >/dev/null
          cd ../..
          
          cp -rf ./mtztemp/flyme9/icons.zip ./addition/mtz/flyme9/icons
          cd addition/mtz/flyme9
          zip -r -9 Flyme9.mtz * >/dev/null
          mv Flyme9.mtz ../../../
          cd ../../../
        fi
        
        # ç»Ÿè®¡å›¾æ ‡æ•°é‡
        echo "ç»Ÿè®¡å›¾æ ‡æ•°é‡..."
        ICON_COUNT=$(ls -1 icons/ | wc -l)
        echo "ICON_COUNT=$ICON_COUNT" >> $GITHUB_ENV
        
        # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
        echo "åˆ›å»ºæž„å»ºä¿¡æ¯..."
        cat > build_info.txt << EOF
        æž„å»ºæ—¶é—´: ${{ env.BUILD_DATE }}
        Git SHA: ${{ env.GIT_SHA }}
        å›¾æ ‡æ•°é‡: $ICON_COUNT
        æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
        æäº¤è€…: ${{ github.event.head_commit.author.name }}
        EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MIUI-Icons-Package-${{ env.BUILD_TIME }}
        path: |
          MIUI_Icons_Module.zip
          Default.mtz
          Icons_Addon.zip
          Icons_Archiving.zip
          Explore.mtz
          Flyme9.mtz
          build_info.txt
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}
        name: MIUI Icons Release ${{ env.BUILD_DATE }}
        body: |
          ## ðŸŽ‰ MIUI å®Œç¾Žå›¾æ ‡è‡ªåŠ¨æž„å»º
          
          **æž„å»ºæ—¶é—´**: ${{ env.BUILD_DATE }}
          
          **Git SHA**: ${{ env.GIT_SHA }}
          
          **å›¾æ ‡æ•°é‡**: ${{ env.ICON_COUNT }}
          
          ### ðŸ“ æ›´æ–°å†…å®¹
          
          ${{ github.event.head_commit.message }}
          
          By ${{ github.event.head_commit.author.name }}
          
          ### ðŸ“¦ åŒ…å«æ–‡ä»¶
          
          - `MIUI_Icons_Module.zip` - Magisk/KernelSU æ¨¡å—
          - `Default.mtz` - é»˜è®¤ä¸»é¢˜åŒ…
          - `Icons_Addon.zip` - å›¾æ ‡æ’ä»¶
          - `Icons_Archiving.zip` - å½’æ¡£å›¾æ ‡
          - `Explore.mtz` - Explore ä¸»é¢˜åŒ…ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          - `Flyme9.mtz` - Flyme9 ä¸»é¢˜åŒ…ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          
          ### ðŸ“± å®‰è£…æ–¹æ³•
          
          **Magisk/KernelSU æ¨¡å—**ï¼š
          1. ä¸‹è½½ `MIUI_Icons_Module.zip`
          2. åœ¨ Magisk/KernelSU ä¸­å®‰è£…æ¨¡å—
          3. é‡å¯è®¾å¤‡
          
          **ä¸»é¢˜åŒ…**ï¼š
          1. ä¸‹è½½å¯¹åº”çš„ `.mtz` æ–‡ä»¶
          2. åœ¨ MIUI ä¸»é¢˜å•†åº—ä¸­å¯¼å…¥
          3. åº”ç”¨ä¸»é¢˜
        files: |
          MIUI_Icons_Module.zip
          Default.mtz
          Icons_Addon.zip
          Icons_Archiving.zip
          Explore.mtz
          Flyme9.mtz
          build_info.txt
        draft: false
        prerelease: false
        
    - name: Clean up
      run: |
        rm -rf mtztemp/
        rm -rf addition/default/
        rm -f MIUI_Icons_Module.zip
        rm -f *.mtz
        rm -f Icons_*.zip
        rm -f build_info.txt