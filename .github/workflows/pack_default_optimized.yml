name: Pack Default Theme with PNG Optimization

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'icons/**'
      - 'themes/default/**'
  workflow_dispatch:
    inputs:
      compression_level:
        description: 'PNG compression level (1-9, higher = better compression)'
        required: false
        default: '7'
        type: choice
        options:
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'

jobs:
  pack-default-theme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup environment
      run: |
        echo "BUILD_TIME=$(TZ=':Asia/Shanghai' date '+%Y%m%d%H%M')" >> $GITHUB_ENV
        echo "BUILD_DATE=$(TZ=':Asia/Shanghai' date '+%Y.%m.%d')" >> $GITHUB_ENV
        echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
    - name: Install PNG optimization tools
      run: |
        # å®‰è£…ä¼˜åŒ–å·¥å…·
        sudo apt-get update
        sudo apt-get install -y optipng pngquant oxipng
        
        # å®‰è£… pngcrush
        sudo apt-get install -y pngcrush
        
    - name: Optimize PNG files
      run: |
        echo "å¼€å§‹ä¼˜åŒ– PNG æ–‡ä»¶..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾ä¼˜åŒ–åŽçš„å›¾æ ‡
        mkdir -p temp_icons
        cp -rf icons/* temp_icons/
        
        # èŽ·å–åŽ‹ç¼©çº§åˆ«
        COMPRESSION_LEVEL="${{ github.event.inputs.compression_level || '7' }}"
        
        # ç»Ÿè®¡åŽŸå§‹å¤§å°
        ORIGINAL_SIZE=$(du -sb icons | cut -f1)
        ORIGINAL_COUNT=$(find icons -name "*.png" | wc -l)
        
        echo "åŽŸå§‹å›¾æ ‡æ•°é‡: $ORIGINAL_COUNT"
        echo "åŽŸå§‹æ€»å¤§å°: $(($ORIGINAL_SIZE / 1024)) KB"
        
        # ä½¿ç”¨å¤šç§å·¥å…·ä¼˜åŒ– PNG
        cd temp_icons
        
        # 1. ä½¿ç”¨ pngquant è¿›è¡Œæœ‰æŸåŽ‹ç¼©ï¼ˆä¿æŒé«˜è´¨é‡ï¼‰
        echo "ä½¿ç”¨ pngquant ä¼˜åŒ–..."
        find . -name "*.png" -print0 | xargs -0 -P$(nproc) -I {} sh -c '
          pngquant --quality=85-100 --speed 1 --force --ext .png "{}" 2>/dev/null || true
        '
        
        # 2. ä½¿ç”¨ optipng è¿›è¡Œæ— æŸåŽ‹ç¼©
        echo "ä½¿ç”¨ optipng ä¼˜åŒ–..."
        find . -name "*.png" -print0 | xargs -0 -P$(nproc) -I {} \
          optipng -quiet -o${COMPRESSION_LEVEL} -preserve "{}"
        
        # 3. ä½¿ç”¨ oxipng è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆæ›´çŽ°ä»£çš„å·¥å…·ï¼‰
        echo "ä½¿ç”¨ oxipng ä¼˜åŒ–..."
        find . -name "*.png" -print0 | xargs -0 -P$(nproc) -I {} \
          oxipng -q -o ${COMPRESSION_LEVEL} --strip safe "{}"
        
        # ç»Ÿè®¡ä¼˜åŒ–åŽçš„å¤§å°
        OPTIMIZED_SIZE=$(du -sb . | cut -f1)
        SAVED_SIZE=$((ORIGINAL_SIZE - OPTIMIZED_SIZE))
        SAVED_PERCENT=$((SAVED_SIZE * 100 / ORIGINAL_SIZE))
        
        echo "ä¼˜åŒ–åŽæ€»å¤§å°: $(($OPTIMIZED_SIZE / 1024)) KB"
        echo "èŠ‚çœç©ºé—´: $(($SAVED_SIZE / 1024)) KB ($SAVED_PERCENT%)"
        
        # ä¿å­˜ä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯
        cd ..
        cat > optimization_report.txt << EOF
        PNG ä¼˜åŒ–æŠ¥å‘Š
        ============
        æž„å»ºæ—¶é—´: ${{ env.BUILD_DATE }}
        åŽ‹ç¼©çº§åˆ«: ${COMPRESSION_LEVEL}
        
        å›¾æ ‡æ•°é‡: $ORIGINAL_COUNT
        åŽŸå§‹å¤§å°: $(($ORIGINAL_SIZE / 1024)) KB
        ä¼˜åŒ–åŽå¤§å°: $(($OPTIMIZED_SIZE / 1024)) KB
        èŠ‚çœç©ºé—´: $(($SAVED_SIZE / 1024)) KB
        åŽ‹ç¼©çŽ‡: $SAVED_PERCENT%
        
        ä½¿ç”¨çš„ä¼˜åŒ–å·¥å…·:
        - pngquant (æœ‰æŸåŽ‹ç¼©ï¼Œè´¨é‡ 85-100)
        - optipng (æ— æŸåŽ‹ç¼©)
        - oxipng (çŽ°ä»£ä¼˜åŒ–å™¨)
        EOF
        
        # å°†ç»Ÿè®¡ä¿¡æ¯æ·»åŠ åˆ°çŽ¯å¢ƒå˜é‡
        echo "ORIGINAL_SIZE=$(($ORIGINAL_SIZE / 1024))" >> $GITHUB_ENV
        echo "OPTIMIZED_SIZE=$(($OPTIMIZED_SIZE / 1024))" >> $GITHUB_ENV
        echo "SAVED_SIZE=$(($SAVED_SIZE / 1024))" >> $GITHUB_ENV
        echo "SAVED_PERCENT=$SAVED_PERCENT" >> $GITHUB_ENV
        echo "ICON_COUNT=$ORIGINAL_COUNT" >> $GITHUB_ENV
        
    - name: Pack default theme
      run: |
        echo "æ‰“åŒ…é»˜è®¤ä¸»é¢˜..."
        
        # å¤åˆ¶é»˜è®¤ä¸»é¢˜æ–‡ä»¶
        cp -rf ./themes/default ./addition
        
        # åˆ›å»ºå›¾æ ‡ç›®å½•å¹¶å¤åˆ¶ä¼˜åŒ–åŽçš„å›¾æ ‡
        mkdir -p ./addition/default/res/drawable-xxhdpi/
        cp -rf temp_icons/* ./addition/default/res/drawable-xxhdpi/
        
        # æ‰“åŒ…
        cd ./addition/default/
        zip -r -9 default_theme.zip * >/dev/null
        
        # ç§»åŠ¨åˆ°æ ¹ç›®å½•
        mv default_theme.zip ../../
        cd ../..
        
        # èŽ·å–æ‰“åŒ…åŽçš„æ–‡ä»¶å¤§å°
        PACKAGE_SIZE=$(ls -lh default_theme.zip | awk '{print $5}')
        echo "PACKAGE_SIZE=$PACKAGE_SIZE" >> $GITHUB_ENV
        
    - name: Generate build info
      run: |
        cat > build_info.txt << EOF
        é»˜è®¤ä¸»é¢˜æž„å»ºä¿¡æ¯
        ================
        æž„å»ºæ—¶é—´: ${{ env.BUILD_DATE }}
        Git SHA: ${{ env.GIT_SHA }}
        
        å›¾æ ‡ç»Ÿè®¡
        --------
        å›¾æ ‡æ•°é‡: ${{ env.ICON_COUNT }}
        åŽŸå§‹å¤§å°: ${{ env.ORIGINAL_SIZE }} KB
        ä¼˜åŒ–åŽå¤§å°: ${{ env.OPTIMIZED_SIZE }} KB
        èŠ‚çœç©ºé—´: ${{ env.SAVED_SIZE }} KB (${{ env.SAVED_PERCENT }}%)
        
        æœ€ç»ˆåŒ…å¤§å°: ${{ env.PACKAGE_SIZE }}
        
        æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
        æäº¤è€…: ${{ github.event.head_commit.author.name }}
        EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Default-Theme-Optimized-${{ env.BUILD_TIME }}
        path: |
          default_theme.zip
          build_info.txt
          optimization_report.txt
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[release]')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: default-v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}
        name: Default Theme ${{ env.BUILD_DATE }} (Optimized)
        body: |
          ## ðŸŽ‰ é»˜è®¤ä¸»é¢˜å‘å¸ƒï¼ˆä¼˜åŒ–ç‰ˆï¼‰
          
          **æž„å»ºæ—¶é—´**: ${{ env.BUILD_DATE }}
          
          **Git SHA**: `${{ env.GIT_SHA }}`
          
          ### ðŸ“Š ä¼˜åŒ–ç»Ÿè®¡
          
          - **å›¾æ ‡æ•°é‡**: ${{ env.ICON_COUNT }}
          - **åŽŸå§‹å¤§å°**: ${{ env.ORIGINAL_SIZE }} KB
          - **ä¼˜åŒ–åŽå¤§å°**: ${{ env.OPTIMIZED_SIZE }} KB
          - **èŠ‚çœç©ºé—´**: ${{ env.SAVED_SIZE }} KB (${{ env.SAVED_PERCENT }}%)
          - **æœ€ç»ˆåŒ…å¤§å°**: ${{ env.PACKAGE_SIZE }}
          
          ### ðŸ“ æ›´æ–°å†…å®¹
          
          ${{ github.event.head_commit.message }}
          
          By @${{ github.event.head_commit.author.name }}
          
          ### ðŸ“¦ ä¸‹è½½æ–‡ä»¶
          
          - `default_theme.zip` - ä¼˜åŒ–åŽçš„é»˜è®¤ä¸»é¢˜åŒ…
          - `build_info.txt` - æž„å»ºä¿¡æ¯
          - `optimization_report.txt` - PNG ä¼˜åŒ–æŠ¥å‘Š
          
          ### ðŸš€ ä¼˜åŒ–è¯´æ˜Ž
          
          æœ¬æ¬¡æž„å»ºä½¿ç”¨äº†å¤šç§ PNG ä¼˜åŒ–å·¥å…·ï¼š
          - **pngquant**: é«˜è´¨é‡æœ‰æŸåŽ‹ç¼©ï¼ˆ85-100 è´¨é‡ï¼‰
          - **optipng**: æ— æŸåŽ‹ç¼©ä¼˜åŒ–
          - **oxipng**: çŽ°ä»£åŒ– PNG ä¼˜åŒ–å™¨
          
          æ‰€æœ‰å›¾æ ‡å‡ç»è¿‡ä¼˜åŒ–å¤„ç†ï¼Œåœ¨ä¿æŒè§†è§‰è´¨é‡çš„åŒæ—¶æ˜¾è‘—å‡å°æ–‡ä»¶å¤§å°ã€‚
        files: |
          default_theme.zip
          build_info.txt
          optimization_report.txt
        draft: false
        prerelease: false
        
    - name: Clean up
      run: |
        rm -rf temp_icons/
        rm -rf addition/default/
        rm -f default_theme.zip
        rm -f build_info.txt
        rm -f optimization_report.txt