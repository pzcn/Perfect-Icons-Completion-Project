name: Auto Pack Module (Advanced)

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'icons/**'
      - 'themes/**'
      - 'addition/module/**'
  pull_request:
    paths:
      - 'icons/**'
      - 'themes/**'
      - 'addition/module/**'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      upload_to_cloud:
        description: 'Upload to cloud storage'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  CACHE_VERSION: v1

jobs:
  pack-module:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - name: module
            output: MIUI_Icons_Module.zip
          - name: default-mtz
            output: Default.mtz
          - name: addon
            output: Icons_Addon.zip
          - name: archiving
            output: Icons_Archiving.zip
          - name: explore-mtz
            output: Explore.mtz
          - name: flyme9-mtz
            output: Flyme9.mtz
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache
          /tmp/icons_cache
        key: ${{ runner.os }}-icons-${{ env.CACHE_VERSION }}-${{ hashFiles('icons/**') }}
        restore-keys: |
          ${{ runner.os }}-icons-${{ env.CACHE_VERSION }}-
          
    - name: Setup environment
      run: |
        echo "BUILD_TIME=$(TZ=':Asia/Shanghai' date '+%Y%m%d%H%M')" >> $GITHUB_ENV
        echo "BUILD_DATE=$(TZ=':Asia/Shanghai' date '+%Y.%m.%d')" >> $GITHUB_ENV
        echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "PACKAGE_NAME=${{ matrix.package.name }}" >> $GITHUB_ENV
        echo "OUTPUT_FILE=${{ matrix.package.output }}" >> $GITHUB_ENV
        
        # åˆ›å»ºç¼“å­˜ç›®å½•
        mkdir -p /tmp/icons_cache
        
    - name: Prepare base resources
      run: |
        # å¤åˆ¶é»˜è®¤ä¸»é¢˜åˆ° addition
        cp -rf ./themes/default ./addition
        
        # å‡†å¤‡åŸºç¡€å›¾æ ‡èµ„æº
        mkdir -p ./addition/default/res/drawable-xxhdpi/
        cp -rf icons/* ./addition/default/res/drawable-xxhdpi/
        
        # ç¼“å­˜åŸºç¡€èµ„æº
        if [ ! -f "/tmp/icons_cache/base_icons.zip" ]; then
          cd ./addition/default/
          zip -r -9 /tmp/icons_cache/base_icons.zip * >/dev/null
          cd ../..
        else
          cp /tmp/icons_cache/base_icons.zip ./addition/default/icons.zip
        fi
        
    - name: Pack ${{ matrix.package.name }}
      run: |
        case "${{ matrix.package.name }}" in
          "module")
            echo "æ‰“åŒ… Magisk æ¨¡å—..."
            cp -rf ./addition/default/icons.zip ./addition/module/icons
            cd ./addition/module
            
            # æ›´æ–° module.prop
            sed -i "s/versionCode=.*/versionCode=${{ env.BUILD_TIME }}/" module.prop
            echo "version=v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}" >> module.prop
            echo "description=MIUI å®Œç¾å›¾æ ‡è¡¥å…¨æ¨¡å— - è‡ªåŠ¨æ„å»ºäº ${{ env.BUILD_DATE }}" >> module.prop
            
            # å‹ç¼©å›¾æ ‡
            XZ_OPT=-9 tar cJf icons.tar.xz icons
            rm -rf icons
            
            # åˆ›å»ºæ¨¡å— zip
            zip -r -9 MIUI_Icons_Module.zip * >/dev/null
            mv MIUI_Icons_Module.zip ../../
            ;;
            
          "default-mtz")
            echo "æ‰“åŒ…é»˜è®¤ MTZ ä¸»é¢˜..."
            cp -rf ./addition/default/icons.zip ./addition/mtz/default/icons
            cd ./addition/mtz/default
            zip -r -9 Default.mtz * >/dev/null
            mv Default.mtz ../../../
            ;;
            
          "addon")
            echo "æ‰“åŒ…å›¾æ ‡æ’ä»¶..."
            cd ./addition/Icons_Addon
            zip -r -9 Icons_Addon.zip * >/dev/null
            mv Icons_Addon.zip ../../
            ;;
            
          "archiving")
            echo "æ‰“åŒ…å½’æ¡£å›¾æ ‡..."
            cd ./addition/Icons_Archiving
            zip -r -9 Icons_Archiving.zip * >/dev/null
            mv Icons_Archiving.zip ../../
            ;;
            
          "explore-mtz")
            echo "æ‰“åŒ… Explore ä¸»é¢˜..."
            if [ -d "themes/explore" ]; then
              mkdir -p mtztemp/explore/res/drawable-xxhdpi/
              cp -rf icons/* mtztemp/explore/res/drawable-xxhdpi/
              [ -d "themes/explore/icons" ] && cp -rf themes/explore/icons/* mtztemp/explore/res/drawable-xxhdpi/
              [ -d "themes/explore/layer_animating_icons" ] && cp -rf themes/explore/layer_animating_icons mtztemp/explore/
              [ -f "themes/explore/transform_config.xml" ] && cp -rf themes/explore/transform_config.xml mtztemp/explore/
              cd mtztemp/explore/
              zip -r -9 icons.zip * >/dev/null
              cd ../..
              
              cp -rf ./mtztemp/explore/icons.zip ./addition/mtz/explore/icons
              cd addition/mtz/explore
              zip -r -9 Explore.mtz * >/dev/null
              mv Explore.mtz ../../../
            else
              echo "Explore theme not found, creating empty file"
              touch Explore.mtz
            fi
            ;;
            
          "flyme9-mtz")
            echo "æ‰“åŒ… Flyme9 ä¸»é¢˜..."
            if [ -d "themes/flyme9" ]; then
              mkdir -p mtztemp/flyme9/res/drawable-xxhdpi/
              cp -rf icons/* mtztemp/flyme9/res/drawable-xxhdpi/
              [ -d "themes/flyme9/icons" ] && cp -rf themes/flyme9/icons/* mtztemp/flyme9/res/drawable-xxhdpi/
              [ -d "themes/flyme9/layer_animating_icons" ] && cp -rf themes/flyme9/layer_animating_icons mtztemp/flyme9/
              [ -f "themes/flyme9/transform_config.xml" ] && cp -rf themes/flyme9/transform_config.xml mtztemp/flyme9/
              cd mtztemp/flyme9/
              zip -r -9 icons.zip * >/dev/null
              cd ../..
              
              cp -rf ./mtztemp/flyme9/icons.zip ./addition/mtz/flyme9/icons
              cd addition/mtz/flyme9
              zip -r -9 Flyme9.mtz * >/dev/null
              mv Flyme9.mtz ../../../
            else
              echo "Flyme9 theme not found, creating empty file"
              touch Flyme9.mtz
            fi
            ;;
        esac
        
    - name: Upload package artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.package.name }}-${{ env.BUILD_TIME }}
        path: ${{ matrix.package.output }}
        retention-days: 30
        if-no-files-found: ignore

  collect-and-release:
    needs: pack-module
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup environment
      run: |
        echo "BUILD_TIME=$(TZ=':Asia/Shanghai' date '+%Y%m%d%H%M')" >> $GITHUB_ENV
        echo "BUILD_DATE=$(TZ=':Asia/Shanghai' date '+%Y.%m.%d')" >> $GITHUB_ENV
        echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts/
        
    - name: Organize artifacts
      run: |
        mkdir -p release
        find artifacts -name "*.zip" -o -name "*.mtz" | xargs -I {} cp {} release/
        
        # ç»Ÿè®¡å›¾æ ‡æ•°é‡
        ICON_COUNT=$(ls -1 icons/ | wc -l)
        echo "ICON_COUNT=$ICON_COUNT" >> $GITHUB_ENV
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        cat > release/build_info.txt << EOF
        æ„å»ºæ—¶é—´: ${{ env.BUILD_DATE }}
        Git SHA: ${{ env.GIT_SHA }}
        å›¾æ ‡æ•°é‡: $ICON_COUNT
        æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
        æäº¤è€…: ${{ github.event.head_commit.author.name }}
        EOF
        
        # åˆ›å»º SHA256 æ ¡éªŒæ–‡ä»¶
        cd release
        sha256sum * > SHA256SUMS.txt
        cd ..
        
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MIUI-Icons-Complete-Package-${{ env.BUILD_TIME }}
        path: release/
        retention-days: 30
        
    - name: Upload to cloud storage
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_cloud == 'true' && secrets.RCLONE_CONFIG != ''
      run: |
        # å®‰è£… rclone
        curl https://rclone.org/install.sh | sudo bash
        
        # é…ç½® rclone
        mkdir -p ~/.config/rclone/
        echo "${{ secrets.RCLONE_CONFIG }}" | base64 --decode > ~/.config/rclone/rclone.conf
        
        # ä¸Šä¼ åˆ°äº‘å­˜å‚¨
        cd release
        for file in *.zip *.mtz; do
          if [ -f "$file" ]; then
            echo "ä¸Šä¼  $file..."
            rclone copy -P "$file" remote:icons/releases/${{ env.BUILD_DATE }}/
          fi
        done
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true' || github.event_name == 'push' && contains(github.event.head_commit.message, '[release]')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}
        name: MIUI Icons Release ${{ env.BUILD_DATE }}
        body: |
          ## ğŸ‰ MIUI å®Œç¾å›¾æ ‡è‡ªåŠ¨æ„å»º
          
          **æ„å»ºæ—¶é—´**: ${{ env.BUILD_DATE }}
          
          **Git SHA**: `${{ env.GIT_SHA }}`
          
          **å›¾æ ‡æ•°é‡**: ${{ env.ICON_COUNT }}
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          
          ${{ github.event.head_commit.message }}
          
          By @${{ github.event.head_commit.author.name }}
          
          ### ğŸ“¦ åŒ…å«æ–‡ä»¶
          
          | æ–‡ä»¶å | è¯´æ˜ | å¤§å° |
          |--------|------|------|
          | `MIUI_Icons_Module.zip` | Magisk/KernelSU æ¨¡å— | ![](https://img.shields.io/github/size/${{ github.repository }}/v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}/MIUI_Icons_Module.zip) |
          | `Default.mtz` | é»˜è®¤ä¸»é¢˜åŒ… | ![](https://img.shields.io/github/size/${{ github.repository }}/v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}/Default.mtz) |
          | `Icons_Addon.zip` | å›¾æ ‡æ’ä»¶ | ![](https://img.shields.io/github/size/${{ github.repository }}/v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}/Icons_Addon.zip) |
          | `Icons_Archiving.zip` | å½’æ¡£å›¾æ ‡ | ![](https://img.shields.io/github/size/${{ github.repository }}/v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}/Icons_Archiving.zip) |
          | `Explore.mtz` | Explore ä¸»é¢˜åŒ… | - |
          | `Flyme9.mtz` | Flyme9 ä¸»é¢˜åŒ… | - |
          
          ### ğŸ“± å®‰è£…æ–¹æ³•
          
          #### Magisk/KernelSU æ¨¡å—
          1. ä¸‹è½½ `MIUI_Icons_Module.zip`
          2. åœ¨ Magisk/KernelSU åº”ç”¨ä¸­å®‰è£…æ¨¡å—
          3. é‡å¯è®¾å¤‡
          
          #### ä¸»é¢˜åŒ…
          1. ä¸‹è½½å¯¹åº”çš„ `.mtz` æ–‡ä»¶
          2. åœ¨ MIUI ä¸»é¢˜å•†åº—ä¸­å¯¼å…¥
          3. åº”ç”¨ä¸»é¢˜
          
          ### ğŸ”’ æ–‡ä»¶æ ¡éªŒ
          
          è¯·æŸ¥çœ‹ `SHA256SUMS.txt` æ–‡ä»¶ä»¥éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
          
          ---
          
          ğŸ’¡ **æç¤º**: å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
        files: |
          release/*
        draft: false
        prerelease: false
        generate_release_notes: true
        
    - name: Push notification
      if: github.event_name == 'push' && secrets.PUSH_TOKEN != ''
      run: |
        # å‘é€æ¨é€é€šçŸ¥
        curl -i -X POST -H 'Content-type':'application/json' \
          -d '{
            "token":"${{ secrets.PUSH_TOKEN }}",
            "title":"MIUI å®Œç¾å›¾æ ‡æ¨¡å—è‡ªåŠ¨æ„å»ºå®Œæˆ",
            "content":"**æ„å»ºæˆåŠŸ** \n\n ç‰ˆæœ¬: v${{ env.BUILD_DATE }}-${{ env.GIT_SHA }} \n\n å›¾æ ‡æ•°é‡: ${{ env.ICON_COUNT }} \n\n æ›´æ–°å†…å®¹: ${{ github.event.head_commit.message }} \n\n [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
            "topic":"MIUI",
            "template":"markdown"
          }' \
          http://www.pushplus.plus/send